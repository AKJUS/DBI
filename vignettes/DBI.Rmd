---
title: "Introduction to DBI"
author: "James Wondrasek"
date: "27 February 2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Introduction to DBI"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Who this tutorial is for
- You have an understanding of R
- You want to access or manipulate data in a database that may be on your machine or on a different computer on the internet
- You have found libraries that use a higher level of abstraction, like [dplyer](missinglink), are not suitable for your purpose
- You have an understanding of SQL, though it is not strictly necessary for basic data access

The {DBI} (**D**ata**B**ase **I**nterface) package provides a simple, consistent interface between R and database management systems (DBMS).  
Each supported DBMS is supported by its own R package that implements the [DBI specification](https://cran.r-project.org/web/packages/DBI/vignettes/spec.html). You may need to install the package specific to your DBMS.

DBI currently supports 30 DBMS, including:

* MySQL, using the R-package [RMySQL](https://github.com/r-dbi/RMySQL)
* MariaDB, using the R-package [RMariaDB](https://github.com/r-dbi/RMariaDB)
* Postgres, using the R-package [RPostgres](https://github.com/r-dbi/RPostgres)
* SQLite, using the R-package [RSQLite](https://github.com/r-dbi/RSQLite)

For the full list of supported DBMS visit [https://github.com/r-dbi/backends](https://github.com/r-dbi/backends)

The functionality currently supported for each of these DBMS's includes:
- [manage a connection to a database](#connecting-to-a-database)
- list the tables in a database [link]
- get table details/column headers/fields [link]
- read a table into a dataframe [link]
- read a portion of a table into a dataframe [link]
- run SQL queries, including parameterised queries [link]

## How to connect to a database using DBI

Connections to databases are created using the `dbConnect()` function. 
The first argument to the function is the driver for the DBMS you are connecting to. 
In the example below we are connecting to a MariaDB instance, so we use the RMariaDB::MariaDB() driver. 
The rest of the arguments depend on the authentication required by the DBMS. In the example username, password, host, port, dbname are required. 
See the documentation for the DBMS driver package that you are using for specifics.
The databse connection will need to be closed at the end of your session. This is covered in the section [How to close a database connection](#how-to-close-a-database-connection).

```{r}
library(DBI)

con <- dbConnect(RMariaDB::MariaDB(), username = "guest", password = "relational", host = "relational.fit.cvut.cz", port = 3306, dbname = "PTE")
con
```

## How to list the tables in a database using DBI

The function `dbListTables()` takes a database connection as its only argument and returns a character vector with all table and view names in the database.

```{r}
dbListTables(con)
```

## How to retrieve column names for a table

We can list the column names for a table with the function `dbListFields()`.
It takes as arguments a database connection and a table name and returns a character vector of the column names in order.


```{r}
dbListFields(con, "pte_bond")
```

## Read a table into a data frame

The function `dbReadTable()` reads an entire table and returns it as a data frame. It is equivalent to the SQL query `SELECT * FROM <name>`.
The columns of the returned data frame share the same names as the columns in the table.

```{r}
df <- dbReadTable(con, "pte_bond")
head(df)
```

## Read the result of an SQL query into a data frame

DBI provides functions to run custom SQL queries and manage the results.
For small datasets where you do not need to manage the number of results being returned, the function `dbGetQuery()` takes a SQL squery and returns a dataframe.

```{r}
df <- dbGetQuery(con, "SELECT * FROM pte_bond WHERE atom_id1 = 'd100_12'")
df
```

## How to run more complex queries using DBI

`dbGetQuery()` is calling a number of functions behind the scenes. 
If you need more control, you can manually build your own query, retrieve results at your selected rate, and release the resources involved, by calling the same functions.

These functions are:
`dbSendQuery()` - sends the SQL query to the DBMS and returns a `result` object.
The query is limited to `SELECT` statements.
If you want to send other statements, such as `INSERT`, `UPDATE`, `DELETE`, etc, use `dbSendStatement()`.

`dbFetch()` - is called with the `result` object returned by `dbSendQuery()`.
It also accepts an argument specifying the number of rows to be returned.

`dbClearResult()` - is called when you have finished retrieving data.
It releases the resources associated with the `result` object.

```{r}
res <- dbSendQuery(con, "SELECT * FROM pte_bond WHERE atom_id1 = 'd100_12'")
df <- dbFetch(res)
dbClearResult(res)
df
```

## How to read part of a table from a database

If your dataset is large you may want to fetch a limited number of rows at a time.
As demonstrated below, this can be accomplished by using a while loop where the function `dbHasCompleted()` is used to check for ongoing rows, and `dbFetch()` is used with the `n = X` argument, specifying how many rows to return on each iteration.
Again, we call `dbClearResult()` at the end to release resources. 

```{r}

res <- dbSendQuery(con, "SELECT * FROM pte_bond")
while(!dbHasCompleted(res)){
  chunk <- dbFetch(res, n = 2500)
  print(nrow(chunk))
}
dbClearResult(res)

```

## How to end a DBMS session

When finished accessing the DBMS, close the connection using `dbDisconnect()`.

```{r}

dbDisconnect(con)

```

## How to use parameters in SQL queries

`dbSendQuery()` can be used with parameterised SQL queries.
For a single set of parameters, the `params` argument can be used. It takes a list and its members are substituted in order for the placeholders within the query. 

```{r}

con <- dbConnect(RMariaDB::MariaDB(), username = "guest", password = "relational", host = "relational.fit.cvut.cz", port = 3306, dbname = "PTE")
res <- dbSendQuery(con, "SELECT * FROM pte_bond WHERE atom_id1 = ?", params = list('d100_11'))
dbFetch(res)
dbClearResult(res)

```

For multiple sets of parameters, `dbBind()` is used.
There are two ways to use `dbBind()`.
It can be used multiple times with same query.

```{r}
res <- dbSendQuery(con, "SELECT * FROM pte_bond WHERE atom_id1 = ?")
dbBind(res, list('d100_11'))
df = dbFetch(res)
dbBind(res, list('d100_12'))
df = dbFetch(res)
dbClearResult(res)

```

Or `dbBind()` can be used to execute the same statement with multiple values at once.

```{r}
# res <- dbSendQuery(con, "SELECT * FROM pte_bond WHERE atom_id1 = $id")
# dbBind(res, list(id = c("d100_11", "d100_12")))
# df <- dbFetch(res)
# dbClearResult(res)
# df
# dbDisconnect(con)
```

## Conclusion

This tutorial has given you the basic techniques for accessing data in any supported DBMS. 
DBI also provides advanced functionality for database manipulation via SQL, as well as executing queries within atomic transactions with commit/rollback support. Details on these can be found in [the DBI specification](https://cran.r-project.org/web/packages/DBI/vignettes/spec.html).

## Further Reading

* An overview on [working with databases in R on Rstudio.com](https://db.rstudio.com/)
* [The DBI specification](https://cran.r-project.org/web/packages/DBI/vignettes/spec.html)
* [List of supported DBMS](https://github.com/r-dbi/backends)

