---
title: "Introduction to DBI"
author: "James Wondrasek, Katharina Brunner"
date: "27 February 2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Introduction to DBI"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Who this tutorial is for

This tutorial is for you if you want to access or manipulate data in a database that may be on your machine or on a different computer on the internet and you have found libraries that use a higher level of abstraction, like [dplyer](https://dplyr.tidyverse.org/), are not suitable for your purpose. 
Depending on what you want to achieve, you may find it useful to have an understanding of SQL.

The DBI (**D**ata**B**ase **I**nterface) package provides a simple, consistent interface between R and database management systems (DBMS).  
Each supported DBMS is supported by its own R package that implements the [DBI specification](https://cran.r-project.org/web/packages/DBI/vignettes/spec.html). 
You may need to install the package specific to your DBMS.

DBI currently supports about 30 DBMS, including:

* MySQL, using the R-package [RMySQL](https://github.com/r-dbi/RMySQL)
* MariaDB, using the R-package [RMariaDB](https://github.com/r-dbi/RMariaDB)
* Postgres, using the R-package [RPostgres](https://github.com/r-dbi/RPostgres)
* SQLite, using the R-package [RSQLite](https://github.com/r-dbi/RSQLite)

For the full list of supported DBMS visit [https://github.com/r-dbi/backends](https://github.com/r-dbi/backends)

The functionality currently supported for each of these DBMS's includes:
- [manage a connection to a database](#how-to-connect-to-a-database-using-dbi)
- list the tables in a database [link]
- list the column names in a table [link]
- read a table into a dataframe [link]

## How to connect to a database using DBI

```{r}
library(DBI)

con <- dbConnect(RMariaDB::MariaDB(), username = "guest", password = "relational", host = "relational.fit.cvut.cz", port = 3306, dbname = "sakila")
dbListTables(con)
dbDisconnect(con)
```

In the above R code we are connecting to the [`Sakila`](https://relational.fit.cvut.cz/dataset/Sakila) database hosted by the Relational Dataset Repository. 
It's a synthetic database representing a fictional movie rental business and includes tables describing films, actors, customers, stores, etc.

Connections to databases are created using the `dbConnect()` function. 
The first argument to the function is the driver for the DBMS you are connecting to. 
In the example above we are connecting to a MariaDB instance, so we use the RMariaDB::MariaDB() driver. 
The rest of the arguments depend on the authentication required by the DBMS. In the example username, password, host, port, dbname are required. 
See the documentation for the DBMS driver package that you are using for specifics.

The function `dbListTables()` takes a database connection as its only argument and returns a character vector with all table and view names in the database.

After completing a session with a DBMS, we release the connection with a call to `dbDisconnect()`.

## How to retrieve column names for a table

We can list the column names for a table with the function `dbListFields()`.
It takes as arguments a database connection and a table name and returns a character vector of the column names in order.


```{r}
con <- dbConnect(RMariaDB::MariaDB(), username = "guest", password = "relational", host = "relational.fit.cvut.cz", port = 3306, dbname = "sakila")
dbListFields(con, "film")
```

## Read a table into a data frame

The function `dbReadTable()` reads an entire table and returns it as a data frame. It is equivalent to the SQL query `SELECT * FROM <name>`.
The columns of the returned data frame share the same names as the columns in the table.

```{r}
df <- dbReadTable(con, "film")
head(df)
```

## Read the result of an SQL query into a data frame

DBI provides functions to run custom SQL queries and manage the results.
For small datasets where you do not need to manage the number of results being returned, the function `dbGetQuery()` takes a SQL squery and returns a dataframe.

```{r}
df <- dbGetQuery(con, "SELECT film_id, title, description FROM film WHERE release_year = 2006")
head(df)
```

```{r}
library(dplyr)
tbl(con, "film") %>% 
  filter(release_year == 2006) %>% 
  select(film_id, title, description)
```

FIXME: Add rquery syntax.

## How to end a DBMS session

When finished accessing the DBMS, always close the connection using `dbDisconnect()`.

```{r}

dbDisconnect(con)

```

## Conclusion

This tutorial has given you the basic techniques for accessing data in any supported DBMS. 
If you need to work with databases that will not fit in memory, or want to run more complex queries, including parameterised queries, please see the [Advanced DBI Usage](missinglink) vignette.


## Further Reading

* An overview on [working with databases in R on Rstudio.com](https://db.rstudio.com/)
* [The DBI specification](https://cran.r-project.org/web/packages/DBI/vignettes/spec.html)
* [List of supported DBMS](https://github.com/r-dbi/backends)
